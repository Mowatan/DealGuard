# DealGuard Production Deployment Guide

## Prerequisites

1. **Clerk Production Keys**
   - Go to https://dashboard.clerk.com
   - Switch to Production environment
   - Copy your `pk_live_...` and `sk_live_...` keys

2. **Mailgun Domain Setup**
   - Verify your domain: `mg.dealguard.org`
   - Get SMTP credentials
   - Set up webhook for inbound email

3. **Database Provider** (Choose one)
   - Railway PostgreSQL (recommended)
   - Supabase
   - Neon
   - AWS RDS

4. **Redis Provider** (Choose one)
   - Railway Redis (recommended)
   - Upstash
   - Redis Cloud

5. **S3 Storage** (Choose one)
   - AWS S3
   - DigitalOcean Spaces
   - Cloudflare R2

---

## Backend Deployment (Railway)

### Step 1: Connect Repository

1. Go to https://railway.app
2. Click "New Project"
3. Select "Deploy from GitHub repo"
4. Choose `Mowatan/DealGuard`
5. Select `fouad-ai/backend` as root directory

### Step 2: Add PostgreSQL Database

1. In your project, click "New"
2. Select "Database" → "PostgreSQL"
3. Railway will automatically create `DATABASE_URL` variable

### Step 3: Add Redis

1. Click "New" → "Database" → "Redis"
2. Railway will automatically create `REDIS_URL` variable

### Step 4: Configure Environment Variables

Add these variables in Railway dashboard:

```bash
# Database (auto-generated by Railway)
DATABASE_URL=postgresql://...

# Redis (auto-generated by Railway)
REDIS_URL=redis://...

# Email - Mailgun
SMTP_HOST=smtp.mailgun.org
SMTP_PORT=587
SMTP_USER=postmaster@mg.dealguard.org
SMTP_PASSWORD=your-mailgun-password
EMAIL_FROM=DealGuard <noreply@dealguard.org>
EMAIL_TEST_MODE=false

# Clerk
CLERK_SECRET_KEY=sk_live_YOUR_KEY
CLERK_PUBLISHABLE_KEY=pk_live_YOUR_KEY

# JWT
JWT_SECRET=generate-strong-64-char-secret

# MinIO/S3
MINIO_ENDPOINT=your-s3-endpoint
MINIO_PORT=443
MINIO_USE_SSL=true
MINIO_ACCESS_KEY=your-access-key
MINIO_SECRET_KEY=your-secret-key

# Frontend URL
FRONTEND_URL=https://dealguard.vercel.app

# Server
NODE_ENV=production
PORT=4000
```

### Step 5: Deploy

1. Railway will automatically deploy on push
2. Your backend will be available at: `https://dealguard-backend.railway.app`

---

## Frontend Deployment (Vercel)

### Step 1: Connect Repository

1. Go to https://vercel.com
2. Click "New Project"
3. Import `Mowatan/DealGuard`
4. Set root directory to `fouad-ai/frontend`
5. Framework Preset: Next.js

### Step 2: Configure Environment Variables

Add these in Vercel dashboard:

```bash
# Clerk Production Keys
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_YOUR_KEY
CLERK_SECRET_KEY=sk_live_YOUR_KEY

# Clerk Routes
NEXT_PUBLIC_CLERK_SIGN_IN_URL=/sign-in
NEXT_PUBLIC_CLERK_SIGN_UP_URL=/sign-up
NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL=/deals
NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL=/deals

# Backend API
NEXT_PUBLIC_API_URL=https://dealguard-backend.railway.app
```

### Step 3: Deploy

1. Click "Deploy"
2. Vercel will build and deploy automatically
3. Your frontend will be at: `https://dealguard.vercel.app`

---

## Post-Deployment Checklist

### Backend Verification

- [ ] Health check: `https://dealguard-backend.railway.app/health`
- [ ] Database migrations ran successfully
- [ ] Redis connection working
- [ ] Clerk authentication working
- [ ] Email sending working (test with deal creation)

### Frontend Verification

- [ ] Site loads: `https://dealguard.vercel.app`
- [ ] Clerk sign-in/sign-up working
- [ ] API calls to backend working
- [ ] Deal creation flow working
- [ ] Service tier selection working

### Security Checklist

- [ ] All `.env` files excluded from git
- [ ] Production secrets are strong and unique
- [ ] CORS configured with allowed origins only
- [ ] Rate limiting enabled
- [ ] HTTPS enabled on all services
- [ ] Database credentials rotated from defaults

---

## Database Migrations

### Initial Setup (First Deploy)

Railway will run migrations automatically via the `deploy` script:
```bash
npm run deploy
# Runs: prisma migrate deploy && prisma generate && npm run build
```

### Future Migrations

After adding new migrations locally:
```bash
# Create migration
cd backend
npx prisma migrate dev --name add_new_feature

# Commit migration files
git add prisma/migrations/
git commit -m "Add database migration for new feature"
git push

# Railway will auto-deploy and run migrations
```

---

## Monitoring & Logs

### Railway Logs

1. Go to Railway dashboard
2. Select your backend service
3. Click "Deployments" → "View Logs"

### Common Issues

**Issue: Prisma Client not found**
Solution: Ensure `postinstall` script runs: `"postinstall": "prisma generate"`

**Issue: Migration failed**
Solution: Check DATABASE_URL is correct and accessible

**Issue: Email not sending**
Solution: Verify Mailgun credentials and domain verification

**Issue: Clerk authentication fails**
Solution: Ensure production keys match between frontend and backend

---

## Rollback Procedure

### Railway Rollback

1. Go to "Deployments" tab
2. Find previous working deployment
3. Click "Redeploy"

### Vercel Rollback

1. Go to "Deployments" tab
2. Find previous working deployment
3. Click "..." → "Promote to Production"

---

## Custom Domain Setup

### Backend Domain

1. In Railway, go to Settings → Domains
2. Add custom domain: `api.dealguard.com`
3. Update DNS records as shown
4. Update `NEXT_PUBLIC_API_URL` in frontend to use custom domain

### Frontend Domain

1. In Vercel, go to Settings → Domains
2. Add custom domain: `www.dealguard.com`
3. Update DNS records as shown
4. Update `FRONTEND_URL` in backend
5. Update `ALLOWED_ORIGINS` in backend

---

## Cost Estimates

### Railway (Backend + Database + Redis)
- Hobby Plan: $5/month (1GB RAM, 1GB storage)
- Pro Plan: $20/month (8GB RAM, 10GB storage)

### Vercel (Frontend)
- Hobby: Free (100GB bandwidth)
- Pro: $20/month (1TB bandwidth)

### Total Monthly Cost
- Development: ~$0-10/month
- Production: ~$25-50/month

---

## Support & Troubleshooting

**Railway Discord**: https://discord.gg/railway
**Vercel Support**: https://vercel.com/support
**Clerk Support**: https://clerk.com/support

For DealGuard specific issues:
- GitHub Issues: https://github.com/Mowatan/DealGuard/issues
